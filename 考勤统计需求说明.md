# 考勤统计需求说明

## 1. 系统概述

### 1.1 数据来源
- 员工花名册.xlsx
- 原始数据.xlsx  
- 休假单.xlsx
- 出差单.xlsx
- 外出单.xlsx
- 日历.xlsx（新增）

**注意：** 每个Excel文件只读取与文件同名的sheet。

### 1.2 员工筛选条件
- 仅统计"全职"员工
- 员工Grade < 13
- 工作地点为"上海"

### 1.3 统计周期
- 按周统计，基于日历文件确定的工作日
- 每周生成两份报表：
  - 详细日统计表
  - 异常考勤汇总表

## 2. 日历规则

### 2.1 日历文件支持
- 读取 `日历.xlsx` 文件中的"法定节假日和调休工作日"sheet
- 日历文件包含两列：
  - 日期：格式为 YYYY-MM-DD
  - 类型：标记为"工作日"、"周末休息"、"法定节假日"或"调休工作日"

### 2.2 日历规则
- **参与考勤统计的日期类型**：
  - "工作日"：正常工作日，参与考勤统计
  - "调休工作日"：调休安排的工作日，参与考勤统计（即使原本为周末）
- **不参与考勤统计的日期类型**：
  - "周末休息"：正常周末休息日，不参与考勤统计
  - "法定节假日"：法定节假日，不参与考勤统计
- **统计原则**：只有标记为"工作日"和"调休工作日"的日期才计入考勤统计

## 3. 请假时长计算规则

### 3.1 基本规则
- 休假单、出差单、外出单均支持"天"或"小时"单位
- 午休时间固定为 12:00-13:00
- 实际请假时长 = 原始请假时长 - 午休时间重叠部分

### 3.2 时间区间调整规则
- 若请假开始时间在12:00-13:00之间（包含12:00和13:00），则开始时间从12:00开始算
- 若请假结束时间在12:00-13:00之间（包含12:00和13:00），则结束时间按13:00算

### 3.3 "小时"单位计算
- 精确用调整后的结束时间-调整后的开始时间计算（如09:30-12:00=2.5小时）
- 若请假结束时间=12:00或开始时间=13:00，自动附赠1小时（午休）

### 3.4 "天"单位计算
- **跨天请假**（如2025-06-04 12:55-2025-06-06 18:00）：
  - 首日：若开始时间在12:00-13:00区间，实际按12:00算，首日请假时长=12:00-18:00=6小时
  - 末日：09:00-结束时间
  - 中间日：全天9小时
- **单天请假**：
  - "上午"=4小时，"下午"=6小时，"全天"=9小时

### 3.5 多条请假处理
- 取所有时间区间的并集（重叠部分不重复计算）
- 单日最多9小时

## 4. 日统计表（详细统计）

### 4.1 表格结构
每天每人一行，包含以下字段：
- 日期、姓名、上班时间、下班时间、工作时长
- 午休时长（固定显示1小时，仅用于展示）
- 实际请假时长（基于优化后的请假时长计算逻辑）
- 应出勤时长（计算公式为 8.75 - 实际请假时长）
- 情况说明、状态、备注

### 4.2 状态分类
1. **正常**：工作时长 ≥ 应出勤时长
2. **未打卡**：无打卡且无请假/出差/外出
3. **上/下班漏打卡**：仅有1次打卡且无请假/出差/外出
4. **出勤不足**：工作时长 < 应出勤时长（无论是否有请假记录）

### 4.3 状态优先级
1. 未打卡（无打卡且无请假记录）
2. 上/下班漏打卡（仅有1次打卡且无请假记录）
3. 出勤不足（工作时长 < 应出勤时长）
4. 正常

### 4.4 格式要求
- 每天数据以日期分段，插入标题行
- 异常状态高亮：
  - 出勤不足：红色
  - 未打卡：橙色
  - 上/下班漏打卡：黄色
- 列宽、行高自动调整，内容完整展示

## 5. 异常考勤汇总表

### 5.1 统计内容
统计每人每周的异常次数，分为：
- 未打卡次数
- 上/下班漏打卡次数
- 出勤不足次数
- 总异常次数

### 5.2 数据来源
- 汇总表数据直接基于统计表的"状态"字段生成
- 列宽、行高自动调整，内容完整展示

## 6. 技术实现

### 6.1 计算精度
- 精确到分钟计算，避免小时舍入误差
- 确保计算精度和边界情况处理正确

### 6.2 部署和打包
- 支持使用 PyInstaller 打包为 Windows 可执行文件 (.exe)
- 打包命令：`pyinstaller --onefile kaoqin.py`
- 打包后的可执行文件包含所有依赖，无需安装 Python 环境

### 6.3 测试和验证
- 提供单元测试脚本验证请假时长计算逻辑
- 测试覆盖跨天请假、单天请假、午休时间调整等场景

## 7. 输出格式

### 7.1 文件格式
- 统计表和汇总表均为Excel格式
- sheet名为"第N周"

### 7.2 数据关系
- 统计表数据为基础，异常表完全基于统计表生成
- 代码需兼容所有上述规则，边界情况需正确处理

---

**本需求文档由对话自动整理生成，覆盖所有历史讨论和细节。** 